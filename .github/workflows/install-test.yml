name: Bundle Installation Test

on:
    push:
        branches:
            - main
            - dev
    pull_request:
        branches:
            - main
            - dev

jobs:
    install-test:
        name: Symfony ${{ matrix.symfony }} / PHP ${{ matrix.php }}
        runs-on: ubuntu-24.04
        strategy:
            fail-fast: false
            matrix:
                include:
                    - php: '8.1'
                      symfony: '6.4.*'
                    - php: '8.2'
                      symfony: '6.4.*'
                    - php: '8.3'
                      symfony: '6.4.*'
                    - php: '8.2'
                      symfony: '7.4.*'
                    - php: '8.3'
                      symfony: '7.4.*'
                    - php: '8.4'
                      symfony: '7.4.*'
                    - php: '8.4'
                      symfony: '8.0.*'

        steps:
            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: mbstring, xml, ctype, iconv, intl, dom, filter, json

            - name: Create Symfony project
              run: |
                  composer create-project symfony/skeleton:"${{ matrix.symfony }}" test-project --no-interaction --prefer-dist
                  cd test-project
                  composer require symfony/framework-bundle symfony/twig-bundle symfony/yaml --no-interaction

            - name: Allow contrib recipes
              working-directory: test-project
              run: |
                  composer config extra.symfony.allow-contrib true

            - name: Install the bundle from Packagist
              working-directory: test-project
              run: |
                  composer require ehyiah/apidoc-bundle --no-interaction

            - name: Verify installation
              working-directory: test-project
              run: |
                  echo "=== bundles.php ==="
                  cat config/bundles.php
                  echo ""
                  echo "=== .env ==="
                  cat .env
                  echo ""
                  echo "=== config/routes/ ==="
                  ls -la config/routes/
                  echo ""
                  echo "=== src/Swagger/ ==="
                  ls -la src/Swagger/ || echo "Directory not created"

            - name: Verify bundle is loaded
              working-directory: test-project
              run: |
                  php bin/console debug:container --parameters --env=dev | grep -i "ehyiah_api_doc"

            - name: Verify routes are registered
              working-directory: test-project
              run: |
                  php bin/console debug:router --env=dev | grep -i "ehyiah"

            - name: Verify commands are available
              working-directory: test-project
              run: |
                  php bin/console list apidocbundle --env=dev

            - name: Test generate command
              working-directory: test-project
              run: |
                  php bin/console apidocbundle:api-doc:generate --format=json --env=dev

            - name: Clear cache
              working-directory: test-project
              run: |
                  php bin/console cache:clear --env=dev
                  php bin/console cache:clear --env=prod
